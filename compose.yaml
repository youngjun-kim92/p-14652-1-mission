services:
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    command:
      - redpanda
      - start
      - --mode
      - dev-container

      # ✅ 내부/외부 리스너 분리: 컨테이너 내부는 9092, 호스트는 19092
      - --kafka-addr
      - internal://0.0.0.0:9092,external://0.0.0.0:19092

      # ✅ 광고 주소: 내부 클라이언트는 redpanda:9092 / 호스트는 localhost:19092
      - --advertise-kafka-addr
      - internal://redpanda:9092,external://localhost:19092

      # (선택) 개발환경에서 리소스 과소/과다를 피하고 싶으면 튜닝 옵션 추가 가능
      # - --smp
      # - "1"
      # - --memory
      # - "1G"
      # - --overprovisioned
      # - --reserved-memory
      # - "0M"

    ports:
      - "19092:19092" # 호스트(스프링 앱) 접근용
      - "9644:9644"   # (선택) Admin API. 필요 없으면 이 라인 제거 가능

    # ✅ 데이터 유지가 필요하면 볼륨 추가
    volumes:
      - redpanda_data:/var/lib/redpanda/data

    healthcheck:
      # ✅ 내부에서 외부 리스너로 체크해도 되고, internal://9092로 해도 됨
      # 여기서는 기존 의도 유지
      test: ["CMD-SHELL", "rpk cluster health -X brokers=localhost:19092 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  console:
    image: docker.redpanda.com/redpandadata/console:latest
    ports:
      - "8090:8080"
    entrypoint: /bin/sh
    command: -c 'echo "$$CONSOLE_CONFIG_FILE" > /tmp/config.yml; /app/console'
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      CONSOLE_CONFIG_FILE: |
        kafka:
          brokers: ["redpanda:9092"]        # ✅ 도커 내부 클라이언트는 internal 리스너 사용
        redpanda:
          adminApi:
            enabled: true
            urls: ["http://redpanda:9644"]  # ✅ 도커 내부에서 admin api 접근

    depends_on:
      redpanda:
        condition: service_healthy  # ✅ "실행 순서"가 아니라 "준비 완료"를 보장

volumes:
  redpanda_data: